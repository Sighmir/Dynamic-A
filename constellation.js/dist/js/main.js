//     Underscore.js 1.4.4
//     http://underscorejs.org
//     (c) 2009-2012 Jeremy Ashkenas, DocumentCloud Inc.
//     Underscore may be freely distributed under the MIT license.

// (c) 2010-2013 Jeremy Ashkenas, DocumentCloud Inc.
// Backbone may be freely distributed under the MIT license.
// For all details and documentation:
// http://backbonejs.org

// Constellation.js 0.2.0
// (c) 2011-2013 Greg MacWilliam
// Freely distributed under the MIT license
// Docs: https://github.com/gmac/constellation.js

/* Copyright (c) 2010-2012 Marcus Westin */

(function(){var e=this,t=e._,n={},r=Array.prototype,i=Object.prototype,s=Function.prototype,o=r.push,u=r.slice,a=r.concat,f=i.toString,l=i.hasOwnProperty,c=r.forEach,h=r.map,p=r.reduce,d=r.reduceRight,v=r.filter,m=r.every,g=r.some,y=r.indexOf,b=r.lastIndexOf,w=Array.isArray,E=Object.keys,S=s.bind,x=function(e){return e instanceof x?e:this instanceof x?(this._wrapped=e,void 0):new x(e)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=x),exports._=x):e._=x,x.VERSION="1.4.4";var T=x.each=x.forEach=function(e,t,r){if(null!=e)if(c&&e.forEach===c)e.forEach(t,r);else if(e.length===+e.length){for(var i=0,s=e.length;s>i;i++)if(t.call(r,e[i],i,e)===n)return}else for(var o in e)if(x.has(e,o)&&t.call(r,e[o],o,e)===n)return};x.map=x.collect=function(e,t,n){var r=[];return null==e?r:h&&e.map===h?e.map(t,n):(T(e,function(e,i,s){r[r.length]=t.call(n,e,i,s)}),r)};var N="Reduce of empty array with no initial value";x.reduce=x.foldl=x.inject=function(e,t,n,r){var i=arguments.length>2;if(null==e&&(e=[]),p&&e.reduce===p)return r&&(t=x.bind(t,r)),i?e.reduce(t,n):e.reduce(t);if(T(e,function(e,s,o){i?n=t.call(r,n,e,s,o):(n=e,i=!0)}),!i)throw new TypeError(N);return n},x.reduceRight=x.foldr=function(e,t,n,r){var i=arguments.length>2;if(null==e&&(e=[]),d&&e.reduceRight===d)return r&&(t=x.bind(t,r)),i?e.reduceRight(t,n):e.reduceRight(t);var s=e.length;if(s!==+s){var o=x.keys(e);s=o.length}if(T(e,function(u,a,f){a=o?o[--s]:--s,i?n=t.call(r,n,e[a],a,f):(n=e[a],i=!0)}),!i)throw new TypeError(N);return n},x.find=x.detect=function(e,t,n){var r;return C(e,function(e,i,s){return t.call(n,e,i,s)?(r=e,!0):void 0}),r},x.filter=x.select=function(e,t,n){var r=[];return null==e?r:v&&e.filter===v?e.filter(t,n):(T(e,function(e,i,s){t.call(n,e,i,s)&&(r[r.length]=e)}),r)},x.reject=function(e,t,n){return x.filter(e,function(e,r,i){return!t.call(n,e,r,i)},n)},x.every=x.all=function(e,t,r){t||(t=x.identity);var i=!0;return null==e?i:m&&e.every===m?e.every(t,r):(T(e,function(e,s,o){return(i=i&&t.call(r,e,s,o))?void 0:n}),!!i)};var C=x.some=x.any=function(e,t,r){t||(t=x.identity);var i=!1;return null==e?i:g&&e.some===g?e.some(t,r):(T(e,function(e,s,o){return i||(i=t.call(r,e,s,o))?n:void 0}),!!i)};x.contains=x.include=function(e,t){return null==e?!1:y&&e.indexOf===y?e.indexOf(t)!=-1:C(e,function(e){return e===t})},x.invoke=function(e,t){var n=u.call(arguments,2),r=x.isFunction(t);return x.map(e,function(e){return(r?t:e[t]).apply(e,n)})},x.pluck=function(e,t){return x.map(e,function(e){return e[t]})},x.where=function(e,t,n){return x.isEmpty(t)?n?null:[]:x[n?"find":"filter"](e,function(e){for(var n in t)if(t[n]!==e[n])return!1;return!0})},x.findWhere=function(e,t){return x.where(e,t,!0)},x.max=function(e,t,n){if(!t&&x.isArray(e)&&e[0]===+e[0]&&65535>e.length)return Math.max.apply(Math,e);if(!t&&x.isEmpty(e))return-1/0;var r={computed:-1/0,value:-1/0};return T(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;o>=r.computed&&(r={value:e,computed:o})}),r.value},x.min=function(e,t,n){if(!t&&x.isArray(e)&&e[0]===+e[0]&&65535>e.length)return Math.min.apply(Math,e);if(!t&&x.isEmpty(e))return 1/0;var r={computed:1/0,value:1/0};return T(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;r.computed>o&&(r={value:e,computed:o})}),r.value},x.shuffle=function(e){var t,n=0,r=[];return T(e,function(e){t=x.random(n++),r[n-1]=r[t],r[t]=e}),r};var k=function(e){return x.isFunction(e)?e:function(t){return t[e]}};x.sortBy=function(e,t,n){var r=k(t);return x.pluck(x.map(e,function(e,t,i){return{value:e,index:t,criteria:r.call(n,e,t,i)}}).sort(function(e,t){var n=e.criteria,r=t.criteria;if(n!==r){if(n>r||n===void 0)return 1;if(r>n||r===void 0)return-1}return e.index<t.index?-1:1}),"value")};var L=function(e,t,n,r){var i={},s=k(t||x.identity);return T(e,function(t,o){var u=s.call(n,t,o,e);r(i,u,t)}),i};x.groupBy=function(e,t,n){return L(e,t,n,function(e,t,n){(x.has(e,t)?e[t]:e[t]=[]).push(n)})},x.countBy=function(e,t,n){return L(e,t,n,function(e,t){x.has(e,t)||(e[t]=0),e[t]++})},x.sortedIndex=function(e,t,n,r){n=null==n?x.identity:k(n);for(var i=n.call(r,t),s=0,o=e.length;o>s;){var u=s+o>>>1;i>n.call(r,e[u])?s=u+1:o=u}return s},x.toArray=function(e){return e?x.isArray(e)?u.call(e):e.length===+e.length?x.map(e,x.identity):x.values(e):[]},x.size=function(e){return null==e?0:e.length===+e.length?e.length:x.keys(e).length},x.first=x.head=x.take=function(e,t,n){return null==e?void 0:null==t||n?e[0]:u.call(e,0,t)},x.initial=function(e,t,n){return u.call(e,0,e.length-(null==t||n?1:t))},x.last=function(e,t,n){return null==e?void 0:null==t||n?e[e.length-1]:u.call(e,Math.max(e.length-t,0))},x.rest=x.tail=x.drop=function(e,t,n){return u.call(e,null==t||n?1:t)},x.compact=function(e){return x.filter(e,x.identity)};var A=function(e,t,n){return T(e,function(e){x.isArray(e)?t?o.apply(n,e):A(e,t,n):n.push(e)}),n};x.flatten=function(e,t){return A(e,t,[])},x.without=function(e){return x.difference(e,u.call(arguments,1))},x.uniq=x.unique=function(e,t,n,r){x.isFunction(t)&&(r=n,n=t,t=!1);var i=n?x.map(e,n,r):e,s=[],o=[];return T(i,function(n,r){(t?r&&o[o.length-1]===n:x.contains(o,n))||(o.push(n),s.push(e[r]))}),s},x.union=function(){return x.uniq(a.apply(r,arguments))},x.intersection=function(e){var t=u.call(arguments,1);return x.filter(x.uniq(e),function(e){return x.every(t,function(t){return x.indexOf(t,e)>=0})})},x.difference=function(e){var t=a.apply(r,u.call(arguments,1));return x.filter(e,function(e){return!x.contains(t,e)})},x.zip=function(){for(var e=u.call(arguments),t=x.max(x.pluck(e,"length")),n=Array(t),r=0;t>r;r++)n[r]=x.pluck(e,""+r);return n},x.object=function(e,t){if(null==e)return{};for(var n={},r=0,i=e.length;i>r;r++)t?n[e[r]]=t[r]:n[e[r][0]]=e[r][1];return n},x.indexOf=function(e,t,n){if(null==e)return-1;var r=0,i=e.length;if(n){if("number"!=typeof n)return r=x.sortedIndex(e,t),e[r]===t?r:-1;r=0>n?Math.max(0,i+n):n}if(y&&e.indexOf===y)return e.indexOf(t,n);for(;i>r;r++)if(e[r]===t)return r;return-1},x.lastIndexOf=function(e,t,n){if(null==e)return-1;var r=null!=n;if(b&&e.lastIndexOf===b)return r?e.lastIndexOf(t,n):e.lastIndexOf(t);for(var i=r?n:e.length;i--;)if(e[i]===t)return i;return-1},x.range=function(e,t,n){1>=arguments.length&&(t=e||0,e=0),n=arguments[2]||1;for(var r=Math.max(Math.ceil((t-e)/n),0),i=0,s=Array(r);r>i;)s[i++]=e,e+=n;return s},x.bind=function(e,t){if(e.bind===S&&S)return S.apply(e,u.call(arguments,1));var n=u.call(arguments,2);return function(){return e.apply(t,n.concat(u.call(arguments)))}},x.partial=function(e){var t=u.call(arguments,1);return function(){return e.apply(this,t.concat(u.call(arguments)))}},x.bindAll=function(e){var t=u.call(arguments,1);return 0===t.length&&(t=x.functions(e)),T(t,function(t){e[t]=x.bind(e[t],e)}),e},x.memoize=function(e,t){var n={};return t||(t=x.identity),function(){var r=t.apply(this,arguments);return x.has(n,r)?n[r]:n[r]=e.apply(this,arguments)}},x.delay=function(e,t){var n=u.call(arguments,2);return setTimeout(function(){return e.apply(null,n)},t)},x.defer=function(e){return x.delay.apply(x,[e,1].concat(u.call(arguments,1)))},x.throttle=function(e,t){var n,r,i,s,o=0,u=function(){o=new Date,i=null,s=e.apply(n,r)};return function(){var a=new Date,f=t-(a-o);return n=this,r=arguments,0>=f?(clearTimeout(i),i=null,o=a,s=e.apply(n,r)):i||(i=setTimeout(u,f)),s}},x.debounce=function(e,t,n){var r,i;return function(){var s=this,o=arguments,u=function(){r=null,n||(i=e.apply(s,o))},a=n&&!r;return clearTimeout(r),r=setTimeout(u,t),a&&(i=e.apply(s,o)),i}},x.once=function(e){var t,n=!1;return function(){return n?t:(n=!0,t=e.apply(this,arguments),e=null,t)}},x.wrap=function(e,t){return function(){var n=[e];return o.apply(n,arguments),t.apply(this,n)}},x.compose=function(){var e=arguments;return function(){for(var t=arguments,n=e.length-1;n>=0;n--)t=[e[n].apply(this,t)];return t[0]}},x.after=function(e,t){return 0>=e?t():function(){return 1>--e?t.apply(this,arguments):void 0}},x.keys=E||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var n in e)x.has(e,n)&&(t[t.length]=n);return t},x.values=function(e){var t=[];for(var n in e)x.has(e,n)&&t.push(e[n]);return t},x.pairs=function(e){var t=[];for(var n in e)x.has(e,n)&&t.push([n,e[n]]);return t},x.invert=function(e){var t={};for(var n in e)x.has(e,n)&&(t[e[n]]=n);return t},x.functions=x.methods=function(e){var t=[];for(var n in e)x.isFunction(e[n])&&t.push(n);return t.sort()},x.extend=function(e){return T(u.call(arguments,1),function(t){if(t)for(var n in t)e[n]=t[n]}),e},x.pick=function(e){var t={},n=a.apply(r,u.call(arguments,1));return T(n,function(n){n in e&&(t[n]=e[n])}),t},x.omit=function(e){var t={},n=a.apply(r,u.call(arguments,1));for(var i in e)x.contains(n,i)||(t[i]=e[i]);return t},x.defaults=function(e){return T(u.call(arguments,1),function(t){if(t)for(var n in t)null==e[n]&&(e[n]=t[n])}),e},x.clone=function(e){return x.isObject(e)?x.isArray(e)?e.slice():x.extend({},e):e},x.tap=function(e,t){return t(e),e};var O=function(e,t,n,r){if(e===t)return 0!==e||1/e==1/t;if(null==e||null==t)return e===t;e instanceof x&&(e=e._wrapped),t instanceof x&&(t=t._wrapped);var i=f.call(e);if(i!=f.call(t))return!1;switch(i){case"[object String]":return e==t+"";case"[object Number]":return e!=+e?t!=+t:0==e?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if("object"!=typeof e||"object"!=typeof t)return!1;for(var s=n.length;s--;)if(n[s]==e)return r[s]==t;n.push(e),r.push(t);var o=0,u=!0;if("[object Array]"==i){if(o=e.length,u=o==t.length)for(;o--&&(u=O(e[o],t[o],n,r)););}else{var a=e.constructor,l=t.constructor;if(a!==l&&!(x.isFunction(a)&&a instanceof a&&x.isFunction(l)&&l instanceof l))return!1;for(var c in e)if(x.has(e,c)&&(o++,!(u=x.has(t,c)&&O(e[c],t[c],n,r))))break;if(u){for(c in t)if(x.has(t,c)&&!(o--))break;u=!o}}return n.pop(),r.pop(),u};x.isEqual=function(e,t){return O(e,t,[],[])},x.isEmpty=function(e){if(null==e)return!0;if(x.isArray(e)||x.isString(e))return 0===e.length;for(var t in e)if(x.has(e,t))return!1;return!0},x.isElement=function(e){return!!e&&1===e.nodeType},x.isArray=w||function(e){return"[object Array]"==f.call(e)},x.isObject=function(e){return e===Object(e)},T(["Arguments","Function","String","Number","Date","RegExp"],function(e){x["is"+e]=function(t){return f.call(t)=="[object "+e+"]"}}),x.isArguments(arguments)||(x.isArguments=function(e){return!!e&&!!x.has(e,"callee")}),"function"!=typeof /./&&(x.isFunction=function(e){return"function"==typeof e}),x.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))},x.isNaN=function(e){return x.isNumber(e)&&e!=+e},x.isBoolean=function(e){return e===!0||e===!1||"[object Boolean]"==f.call(e)},x.isNull=function(e){return null===e},x.isUndefined=function(e){return e===void 0},x.has=function(e,t){return l.call(e,t)},x.noConflict=function(){return e._=t,this},x.identity=function(e){return e},x.times=function(e,t,n){for(var r=Array(e),i=0;e>i;i++)r[i]=t.call(n,i);return r},x.random=function(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))};var M={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};M.unescape=x.invert(M.escape);var _={escape:RegExp("["+x.keys(M.escape).join("")+"]","g"),unescape:RegExp("("+x.keys(M.unescape).join("|")+")","g")};x.each(["escape","unescape"],function(e){x[e]=function(t){return null==t?"":(""+t).replace(_[e],function(t){return M[e][t]})}}),x.result=function(e,t){if(null==e)return null;var n=e[t];return x.isFunction(n)?n.call(e):n},x.mixin=function(e){T(x.functions(e),function(t){var n=x[t]=e[t];x.prototype[t]=function(){var e=[this._wrapped];return o.apply(e,arguments),j.call(this,n.apply(x,e))}})};var D=0;x.uniqueId=function(e){var t=++D+"";return e?e+t:t},x.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var P=/(.)^/,H={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},B=/\\|'|\r|\n|\t|\u2028|\u2029/g;x.template=function(e,t,n){var r;n=x.defaults({},n,x.templateSettings);var i=RegExp([(n.escape||P).source,(n.interpolate||P).source,(n.evaluate||P).source].join("|")+"|$","g"),s=0,o="__p+='";e.replace(i,function(t,n,r,i,u){return o+=e.slice(s,u).replace(B,function(e){return"\\"+H[e]}),n&&(o+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'"),r&&(o+="'+\n((__t=("+r+"))==null?'':__t)+\n'"),i&&(o+="';\n"+i+"\n__p+='"),s=u+t.length,t}),o+="';\n",n.variable||(o="with(obj||{}){\n"+o+"}\n"),o="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+o+"return __p;\n";try{r=Function(n.variable||"obj","_",o)}catch(u){throw u.source=o,u}if(t)return r(t,x);var a=function(e){return r.call(this,e,x)};return a.source="function("+(n.variable||"obj")+"){\n"+o+"}",a},x.chain=function(e){return x(e).chain()};var j=function(e){return this._chain?x(e).chain():e};x.mixin(x),T(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=r[e];x.prototype[e]=function(){var n=this._wrapped;return t.apply(n,arguments),"shift"!=e&&"splice"!=e||0!==n.length||delete n[0],j.call(this,n)}}),T(["concat","join","slice"],function(e){var t=r[e];x.prototype[e]=function(){return j.call(this,t.apply(this._wrapped,arguments))}}),x.extend(x.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}).call(this),define("lib/underscore",[],function(){return _}),define("lib/backbone",["./underscore","./jquery"],function(e,t){var n,r;return n=r={},function(){var e=this,t=e.Backbone,n=[],i=n.push,s=n.slice,o=n.splice,u;typeof r!="undefined"?u=r:u=e.Backbone={},u.VERSION="1.0.0";var a=e._;!a&&typeof require!="undefined"&&(a=require("underscore")),u.$=e.jQuery||e.Zepto||e.ender||e.$,u.noConflict=function(){return e.Backbone=t,this},u.emulateHTTP=!1,u.emulateJSON=!1;var f=u.Events={on:function(e,t,n){if(!c(this,"on",e,[t,n])||!t)return this;this._events||(this._events={});var r=this._events[e]||(this._events[e]=[]);return r.push({callback:t,context:n,ctx:n||this}),this},once:function(e,t,n){if(!c(this,"once",e,[t,n])||!t)return this;var r=this,i=a.once(function(){r.off(e,i),t.apply(this,arguments)});return i._callback=t,this.on(e,i,n)},off:function(e,t,n){var r,i,s,o,u,f,l,h;if(!this._events||!c(this,"off",e,[t,n]))return this;if(!e&&!t&&!n)return this._events={},this;o=e?[e]:a.keys(this._events);for(u=0,f=o.length;u<f;u++){e=o[u];if(s=this._events[e]){this._events[e]=r=[];if(t||n)for(l=0,h=s.length;l<h;l++)i=s[l],(t&&t!==i.callback&&t!==i.callback._callback||n&&n!==i.context)&&r.push(i);r.length||delete this._events[e]}}return this},trigger:function(e){if(!this._events)return this;var t=s.call(arguments,1);if(!c(this,"trigger",e,t))return this;var n=this._events[e],r=this._events.all;return n&&h(n,t),r&&h(r,arguments),this},stopListening:function(e,t,n){var r=this._listeners;if(!r)return this;var i=!t&&!n;typeof t=="object"&&(n=this),e&&((r={})[e._listenerId]=e);for(var s in r)r[s].off(t,n,this),i&&delete this._listeners[s];return this}},l=/\s+/,c=function(e,t,n,r){if(!n)return!0;if(typeof n=="object"){for(var i in n)e[t].apply(e,[i,n[i]].concat(r));return!1}if(l.test(n)){var s=n.split(l);for(var o=0,u=s.length;o<u;o++)e[t].apply(e,[s[o]].concat(r));return!1}return!0},h=function(e,t){var n,r=-1,i=e.length,s=t[0],o=t[1],u=t[2];switch(t.length){case 0:while(++r<i)(n=e[r]).callback.call(n.ctx);return;case 1:while(++r<i)(n=e[r]).callback.call(n.ctx,s);return;case 2:while(++r<i)(n=e[r]).callback.call(n.ctx,s,o);return;case 3:while(++r<i)(n=e[r]).callback.call(n.ctx,s,o,u);return;default:while(++r<i)(n=e[r]).callback.apply(n.ctx,t)}},p={listenTo:"on",listenToOnce:"once"};a.each(p,function(e,t){f[t]=function(t,n,r){var i=this._listeners||(this._listeners={}),s=t._listenerId||(t._listenerId=a.uniqueId("l"));return i[s]=t,typeof n=="object"&&(r=this),t[e](n,r,this),this}}),f.bind=f.on,f.unbind=f.off,a.extend(u,f);var d=u.Model=function(e,t){var n,r=e||{};t||(t={}),this.cid=a.uniqueId("c"),this.attributes={},a.extend(this,a.pick(t,v)),t.parse&&(r=this.parse(r,t)||{});if(n=a.result(this,"defaults"))r=a.defaults({},r,n);this.set(r,t),this.changed={},this.initialize.apply(this,arguments)},v=["url","urlRoot","collection"];a.extend(d.prototype,f,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(e){return a.clone(this.attributes)},sync:function(){return u.sync.apply(this,arguments)},get:function(e){return this.attributes[e]},escape:function(e){return a.escape(this.get(e))},has:function(e){return this.get(e)!=null},set:function(e,t,n){var r,i,s,o,u,f,l,c;if(e==null)return this;typeof e=="object"?(i=e,n=t):(i={})[e]=t,n||(n={});if(!this._validate(i,n))return!1;s=n.unset,u=n.silent,o=[],f=this._changing,this._changing=!0,f||(this._previousAttributes=a.clone(this.attributes),this.changed={}),c=this.attributes,l=this._previousAttributes,this.idAttribute in i&&(this.id=i[this.idAttribute]);for(r in i)t=i[r],a.isEqual(c[r],t)||o.push(r),a.isEqual(l[r],t)?delete this.changed[r]:this.changed[r]=t,s?delete c[r]:c[r]=t;if(!u){o.length&&(this._pending=!0);for(var h=0,p=o.length;h<p;h++)this.trigger("change:"+o[h],this,c[o[h]],n)}if(f)return this;if(!u)while(this._pending)this._pending=!1,this.trigger("change",this,n);return this._pending=!1,this._changing=!1,this},unset:function(e,t){return this.set(e,void 0,a.extend({},t,{unset:!0}))},clear:function(e){var t={};for(var n in this.attributes)t[n]=void 0;return this.set(t,a.extend({},e,{unset:!0}))},hasChanged:function(e){return e==null?!a.isEmpty(this.changed):a.has(this.changed,e)},changedAttributes:function(e){if(!e)return this.hasChanged()?a.clone(this.changed):!1;var t,n=!1,r=this._changing?this._previousAttributes:this.attributes;for(var i in e){if(a.isEqual(r[i],t=e[i]))continue;(n||(n={}))[i]=t}return n},previous:function(e){return e==null||!this._previousAttributes?null:this._previousAttributes[e]},previousAttributes:function(){return a.clone(this._previousAttributes)},fetch:function(e){e=e?a.clone(e):{},e.parse===void 0&&(e.parse=!0);var t=this,n=e.success;return e.success=function(r){if(!t.set(t.parse(r,e),e))return!1;n&&n(t,r,e),t.trigger("sync",t,r,e)},F(this,e),this.sync("read",this,e)},save:function(e,t,n){var r,i,s,o=this.attributes;e==null||typeof e=="object"?(r=e,n=t):(r={})[e]=t;if(r&&(!n||!n.wait)&&!this.set(r,n))return!1;n=a.extend({validate:!0},n);if(!this._validate(r,n))return!1;r&&n.wait&&(this.attributes=a.extend({},o,r)),n.parse===void 0&&(n.parse=!0);var u=this,f=n.success;return n.success=function(e){u.attributes=o;var t=u.parse(e,n);n.wait&&(t=a.extend(r||{},t));if(a.isObject(t)&&!u.set(t,n))return!1;f&&f(u,e,n),u.trigger("sync",u,e,n)},F(this,n),i=this.isNew()?"create":n.patch?"patch":"update",i==="patch"&&(n.attrs=r),s=this.sync(i,this,n),r&&n.wait&&(this.attributes=o),s},destroy:function(e){e=e?a.clone(e):{};var t=this,n=e.success,r=function(){t.trigger("destroy",t,t.collection,e)};e.success=function(i){(e.wait||t.isNew())&&r(),n&&n(t,i,e),t.isNew()||t.trigger("sync",t,i,e)};if(this.isNew())return e.success(),!1;F(this,e);var i=this.sync("delete",this,e);return e.wait||r(),i},url:function(){var e=a.result(this,"urlRoot")||a.result(this.collection,"url")||j();return this.isNew()?e:e+(e.charAt(e.length-1)==="/"?"":"/")+encodeURIComponent(this.id)},parse:function(e,t){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},isValid:function(e){return this._validate({},a.extend(e||{},{validate:!0}))},_validate:function(e,t){if(!t.validate||!this.validate)return!0;e=a.extend({},this.attributes,e);var n=this.validationError=this.validate(e,t)||null;return n?(this.trigger("invalid",this,n,a.extend(t||{},{validationError:n})),!1):!0}});var m=["keys","values","pairs","invert","pick","omit"];a.each(m,function(e){d.prototype[e]=function(){var t=s.call(arguments);return t.unshift(this.attributes),a[e].apply(a,t)}});var g=u.Collection=function(e,t){t||(t={}),t.url&&(this.url=t.url),t.model&&(this.model=t.model),t.comparator!==void 0&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,a.extend({silent:!0},t))},y={add:!0,remove:!0,merge:!0},b={add:!0,merge:!1,remove:!1};a.extend(g.prototype,f,{model:d,initialize:function(){},toJSON:function(e){return this.map(function(t){return t.toJSON(e)})},sync:function(){return u.sync.apply(this,arguments)},add:function(e,t){return this.set(e,a.defaults(t||{},b))},remove:function(e,t){e=a.isArray(e)?e.slice():[e],t||(t={});var n,r,i,s;for(n=0,r=e.length;n<r;n++){s=this.get(e[n]);if(!s)continue;delete this._byId[s.id],delete this._byId[s.cid],i=this.indexOf(s),this.models.splice(i,1),this.length--,t.silent||(t.index=i,s.trigger("remove",s,this,t)),this._removeReference(s)}return this},set:function(e,t){t=a.defaults(t||{},y),t.parse&&(e=this.parse(e,t)),a.isArray(e)||(e=e?[e]:[]);var n,r,s,u,f,l,c=t.at,h=this.comparator&&c==null&&t.sort!==!1,p=a.isString(this.comparator)?this.comparator:null,d=[],v=[],m={};for(n=0,r=e.length;n<r;n++){if(!(s=this._prepareModel(e[n],t)))continue;(f=this.get(s))?(t.remove&&(m[f.cid]=!0),t.merge&&(f.set(s.attributes,t),h&&!l&&f.hasChanged(p)&&(l=!0))):t.add&&(d.push(s),s.on("all",this._onModelEvent,this),this._byId[s.cid]=s,s.id!=null&&(this._byId[s.id]=s))}if(t.remove){for(n=0,r=this.length;n<r;++n)m[(s=this.models[n]).cid]||v.push(s);v.length&&this.remove(v,t)}d.length&&(h&&(l=!0),this.length+=d.length,c!=null?o.apply(this.models,[c,0].concat(d)):i.apply(this.models,d)),l&&this.sort({silent:!0});if(t.silent)return this;for(n=0,r=d.length;n<r;n++)(s=d[n]).trigger("add",s,this,t);return l&&this.trigger("sort",this,t),this},reset:function(e,t){t||(t={});for(var n=0,r=this.models.length;n<r;n++)this._removeReference(this.models[n]);return t.previousModels=this.models,this._reset(),this.add(e,a.extend({silent:!0},t)),t.silent||this.trigger("reset",this,t),this},push:function(e,t){return e=this._prepareModel(e,t),this.add(e,a.extend({at:this.length},t)),e},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e),t},unshift:function(e,t){return e=this._prepareModel(e,t),this.add(e,a.extend({at:0},t)),e},shift:function(e){var t=this.at(0);return this.remove(t,e),t},slice:function(e,t){return this.models.slice(e,t)},get:function(e){return e==null?void 0:this._byId[e.id!=null?e.id:e.cid||e]},at:function(e){return this.models[e]},where:function(e,t){return a.isEmpty(e)?t?void 0:[]:this[t?"find":"filter"](function(t){for(var n in e)if(e[n]!==t.get(n))return!1;return!0})},findWhere:function(e){return this.where(e,!0)},sort:function(e){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return e||(e={}),a.isString(this.comparator)||this.comparator.length===1?this.models=this.sortBy(this.comparator,this):this.models.sort(a.bind(this.comparator,this)),e.silent||this.trigger("sort",this,e),this},sortedIndex:function(e,t,n){t||(t=this.comparator);var r=a.isFunction(t)?t:function(e){return e.get(t)};return a.sortedIndex(this.models,e,r,n)},pluck:function(e){return a.invoke(this.models,"get",e)},fetch:function(e){e=e?a.clone(e):{},e.parse===void 0&&(e.parse=!0);var t=e.success,n=this;return e.success=function(r){var i=e.reset?"reset":"set";n[i](r,e),t&&t(n,r,e),n.trigger("sync",n,r,e)},F(this,e),this.sync("read",this,e)},create:function(e,t){t=t?a.clone(t):{};if(!(e=this._prepareModel(e,t)))return!1;t.wait||this.add(e,t);var n=this,r=t.success;return t.success=function(i){t.wait&&n.add(e,t),r&&r(e,i,t)},e.save(null,t),e},parse:function(e,t){return e},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(e,t){if(e instanceof d)return e.collection||(e.collection=this),e;t||(t={}),t.collection=this;var n=new this.model(e,t);return n._validate(e,t)?n:(this.trigger("invalid",this,e,t),!1)},_removeReference:function(e){this===e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,n,r){if((e==="add"||e==="remove")&&n!==this)return;e==="destroy"&&this.remove(t,r),t&&e==="change:"+t.idAttribute&&(delete this._byId[t.previous(t.idAttribute)],t.id!=null&&(this._byId[t.id]=t)),this.trigger.apply(this,arguments)}});var w=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"];a.each(w,function(e){g.prototype[e]=function(){var t=s.call(arguments);return t.unshift(this.models),a[e].apply(a,t)}});var E=["groupBy","countBy","sortBy"];a.each(E,function(e){g.prototype[e]=function(t,n){var r=a.isFunction(t)?t:function(e){return e.get(t)};return a[e](this.models,r,n)}});var S=u.View=function(e){this.cid=a.uniqueId("view"),this._configure(e||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},x=/^(\S+)\s*(.*)$/,T=["model","collection","el","id","attributes","className","tagName","events"];a.extend(S.prototype,f,{tagName:"div",$:function(e){return this.$el.find(e)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},setElement:function(e,t){return this.$el&&this.undelegateEvents(),this.$el=e instanceof u.$?e:u.$(e),this.el=this.$el[0],t!==!1&&this.delegateEvents(),this},delegateEvents:function(e){if(!e&&!(e=a.result(this,"events")))return this;this.undelegateEvents();for(var t in e){var n=e[t];a.isFunction(n)||(n=this[e[t]]);if(!n)continue;var r=t.match(x),i=r[1],s=r[2];n=a.bind(n,this),i+=".delegateEvents"+this.cid,s===""?this.$el.on(i,n):this.$el.on(i,s,n)}return this},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},_configure:function(e){this.options&&(e=a.extend({},a.result(this,"options"),e)),a.extend(this,a.pick(e,T)),this.options=e},_ensureElement:function(){if(!this.el){var e=a.extend({},a.result(this,"attributes"));this.id&&(e.id=a.result(this,"id")),this.className&&(e["class"]=a.result(this,"className"));var t=u.$("<"+a.result(this,"tagName")+">").attr(e);this.setElement(t,!1)}else this.setElement(a.result(this,"el"),!1)}}),u.sync=function(e,t,n){var r=N[e];a.defaults(n||(n={}),{emulateHTTP:u.emulateHTTP,emulateJSON:u.emulateJSON});var i={type:r,dataType:"json"};n.url||(i.url=a.result(t,"url")||j()),n.data==null&&t&&(e==="create"||e==="update"||e==="patch")&&(i.contentType="application/json",i.data=JSON.stringify(n.attrs||t.toJSON(n))),n.emulateJSON&&(i.contentType="application/x-www-form-urlencoded",i.data=i.data?{model:i.data}:{});if(n.emulateHTTP&&(r==="PUT"||r==="DELETE"||r==="PATCH")){i.type="POST",n.emulateJSON&&(i.data._method=r);var s=n.beforeSend;n.beforeSend=function(e){e.setRequestHeader("X-HTTP-Method-Override",r);if(s)return s.apply(this,arguments)}}i.type!=="GET"&&!n.emulateJSON&&(i.processData=!1),i.type==="PATCH"&&window.ActiveXObject&&(!window.external||!window.external.msActiveXFilteringEnabled)&&(i.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var o=n.xhr=u.ajax(a.extend(i,n));return t.trigger("request",t,o,n),o};var N={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};u.ajax=function(){return u.$.ajax.apply(u.$,arguments)};var C=u.Router=function(e){e||(e={}),e.routes&&(this.routes=e.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},k=/\((.*?)\)/g,L=/(\(\?)?:\w+/g,A=/\*\w+/g,O=/[\-{}\[\]+?.,\\\^$|#\s]/g;a.extend(C.prototype,f,{initialize:function(){},route:function(e,t,n){a.isRegExp(e)||(e=this._routeToRegExp(e)),a.isFunction(t)&&(n=t,t=""),n||(n=this[t]);var r=this;return u.history.route(e,function(i){var s=r._extractParameters(e,i);n&&n.apply(r,s),r.trigger.apply(r,["route:"+t].concat(s)),r.trigger("route",t,s),u.history.trigger("route",r,t,s)}),this},navigate:function(e,t){return u.history.navigate(e,t),this},_bindRoutes:function(){if(!this.routes)return;this.routes=a.result(this,"routes");var e,t=a.keys(this.routes);while((e=t.pop())!=null)this.route(e,this.routes[e])},_routeToRegExp:function(e){return e=e.replace(O,"\\$&").replace(k,"(?:$1)?").replace(L,function(e,t){return t?e:"([^/]+)"}).replace(A,"(.*?)"),new RegExp("^"+e+"$")},_extractParameters:function(e,t){var n=e.exec(t).slice(1);return a.map(n,function(e){return e?decodeURIComponent(e):null})}});var M=u.History=function(){this.handlers=[],a.bindAll(this,"checkUrl"),typeof window!="undefined"&&(this.location=window.location,this.history=window.history)},_=/^[#\/]|\s+$/g,D=/^\/+|\/+$/g,P=/msie [\w.]+/,H=/\/$/;M.started=!1,a.extend(M.prototype,f,{interval:50,getHash:function(e){var t=(e||this).location.href.match(/#(.*)$/);return t?t[1]:""},getFragment:function(e,t){if(e==null)if(this._hasPushState||!this._wantsHashChange||t){e=this.location.pathname;var n=this.root.replace(H,"");e.indexOf(n)||(e=e.substr(n.length))}else e=this.getHash();return e.replace(_,"")},start:function(e){if(M.started)throw new Error("Backbone.history has already been started");M.started=!0,this.options=a.extend({},{root:"/"},this.options,e),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var t=this.getFragment(),n=document.documentMode,r=P.exec(navigator.userAgent.toLowerCase())&&(!n||n<=7);this.root=("/"+this.root+"/").replace(D,"/"),r&&this._wantsHashChange&&(this.iframe=u.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(t)),this._hasPushState?u.$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!r?u.$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=t;var i=this.location,s=i.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!s)return this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0;this._wantsPushState&&this._hasPushState&&s&&i.hash&&(this.fragment=this.getHash().replace(_,""),this.history.replaceState({},document.title,this.root+this.fragment+i.search));if(!this.options.silent)return this.loadUrl()},stop:function(){u.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),M.started=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(e){var t=this.getFragment();t===this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe)));if(t===this.fragment)return!1;this.iframe&&this.navigate(t),this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(e){var t=this.fragment=this.getFragment(e),n=a.any(this.handlers,function(e){if(e.route.test(t))return e.callback(t),!0});return n},navigate:function(e,t){if(!M.started)return!1;if(!t||t===!0)t={trigger:t};e=this.getFragment(e||"");if(this.fragment===e)return;this.fragment=e;var n=this.root+e;if(this._hasPushState)this.history[t.replace?"replaceState":"pushState"]({},document.title,n);else{if(!this._wantsHashChange)return this.location.assign(n);this._updateHash(this.location,e,t.replace),this.iframe&&e!==this.getFragment(this.getHash(this.iframe))&&(t.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,e,t.replace))}t.trigger&&this.loadUrl(e)},_updateHash:function(e,t,n){if(n){var r=e.href.replace(/(javascript:|#).*$/,"");e.replace(r+"#"+t)}else e.hash="#"+t}}),u.history=new M;var B=function(e,t){var n=this,r;e&&a.has(e,"constructor")?r=e.constructor:r=function(){return n.apply(this,arguments)},a.extend(r,n,t);var i=function(){this.constructor=r};return i.prototype=n.prototype,r.prototype=new i,e&&a.extend(r.prototype,e),r.__super__=n.prototype,r};d.extend=g.extend=C.extend=S.extend=M.extend=B;var j=function(){throw new Error('A "url" property or function must be specified')},F=function(e,t){var n=t.error;t.error=function(r){n&&n(e,r,t),e.trigger("error",e,r,t)}}}.call(this),function(e,t,n){function r(){return((1+Math.random())*65536|0).toString(16).substring(1)}function i(){return r()+r()+"-"+r()+"-"+r()+"-"+r()+"-"+r()+r()+r()}e.LocalStorage=window.Store=function(e){this.name=e;var t=this.localStorage().getItem(this.name);this.records=t&&t.split(",")||[]},t.extend(e.LocalStorage.prototype,{save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(e){return e.id||(e.id=i(),e.set(e.idAttribute,e.id)),this.localStorage().setItem(this.name+"-"+e.id,JSON.stringify(e)),this.records.push(e.id.toString()),this.save(),e.toJSON()},update:function(e){return this.localStorage().setItem(this.name+"-"+e.id,JSON.stringify(e)),t.include(this.records,e.id.toString())||this.records.push(e.id.toString()),this.save(),e.toJSON()},find:function(e){return JSON.parse(this.localStorage().getItem(this.name+"-"+e.id))},findAll:function(){return t(this.records).chain().map(function(e){return JSON.parse(this.localStorage().getItem(this.name+"-"+e))},this).compact().value()},destroy:function(e){return this.localStorage().removeItem(this.name+"-"+e.id),this.records=t.reject(this.records,function(t){return t==e.id.toString()}),this.save(),e},localStorage:function(){return localStorage}}),e.LocalStorage.sync=window.Store.sync=e.localSync=function(e,t,r,i){var s=t.localStorage||t.collection.localStorage;typeof r=="function"&&(r={success:r,error:i});var o,u=n.Deferred&&n.Deferred();switch(e){case"read":o=t.id!=undefined?s.find(t):s.findAll();break;case"create":o=s.create(t);break;case"update":o=s.update(t);break;case"delete":o=s.destroy(t)}return o?(r.success(o),u&&u.resolve()):(r.error("Record not found"),u&&u.reject()),u&&u.promise()},e.ajaxSync=e.sync,e.getSyncMethod=function(t){return t.localStorage||t.collection&&t.collection.localStorage?e.localSync:e.ajaxSync},e.sync=function(t,n,r,i){return e.getSyncMethod(n).apply(this,[t,n,r,i])}}(n,e,t),r}),function(e,t){var n=t(Math.sqrt,Math.min,Math.max,Math.abs);"undefined"!=typeof exports?module.exports=n:"function"==typeof define&&define.amd?define("lib/constellation",n):e.Const=n}(this,function(e,t,n,r){function i(e){return e instanceof Array}function s(e){return"function"==typeof e}function o(e){return Array.prototype.slice.call(e)}function u(e,t,n,r){return e===n&&t===r||e===r&&t===n}function a(e,t,n,r,i){if(r.length&&i.length){for(var s=0;r.length>s;s++)if(h.contains(i,r[s]))return!0;var o=e.getAdjacentPolygonSegments(r,i);for(s=0;o.length>s;s++){var u=h.map(o[s],e.getNodeById,e);if(c.intersect(t,n,u[0],u[1]))return!0}}return!1}function f(e,t,n){var r=e.addNode(t.x,t.y,{});if(!n.length){var i=e.snapPointToGrid(t);if(i.point){r.x=i.point.x,r.y=i.point.y,r.snap=i;for(var s=0,o=i.segment.length;o>s;s++)e.joinNodes(r.id,i.segment[s]);n=e.getPolygonsWithLineSegment(i.segment[0],i.segment[1])}}return n.length&&(r.poly=n,h.each(n,function(t){for(var n=e.getPolygonById(t).nodes,i=0,s=n.length;s>i;i++)e.joinNodes(r.id,n[i])})),r}function l(e,t){if(e.snap&&t.snap){var n=e.snap.segment,r=t.snap.segment;if(u(n[0],n[1],r[0],r[1]))return!0}if(e.poly&&t.poly)for(var i in e.poly)if(h.contains(t.poly,e.poly[i]))return!0;return!1}var c={},h=c.utils={size:function(e){if(i(e))return e.length;var t=0;for(var n in e)e.hasOwnProperty(n)&&t++;return t},contains:function(e,t){if(i(e)){if(s(Array.prototype.indexOf))return e.indexOf(t)>=0;for(var n=e.length,r=0;n>r;)if(e[r++]===t)return!0}return e&&e.hasOwnProperty(t)},each:function(e,t,n){var r=0;if(i(e))for(var s=e.length;s>r;)t.call(n,e[r],r++);else for(r in e)e.hasOwnProperty(r)&&t.call(n,e[r],r);return e},map:function(e,t,n){var r=0;if(i(e))for(var s=e.length;s>r;)e[r]=t.call(n,e[r],r++);else for(r in e)e.hasOwnProperty(r)&&(e[r]=t.call(n,e[r],r));return e},all:function(e,t,n){for(var r=e.length,i=0;r>i;)if(!t.call(n,e[i],i++))return!1;return!0},toArray:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(e[n]);return t}},p=c.Point=function(e,t){this.x=e||0,this.y=t||0},d=c.Rect=function(e,t,n,r){this.x=e||0,this.y=t||0,this.width=n||0,this.height=r||0};c.distance=function(t,n){var r=n.x-t.x,i=n.y-t.y;return e(r*r+i*i)},c.ccw=function(e,t,n,r){return r?(n.y-e.y)*(t.x-e.x)>(t.y-e.y)*(n.x-e.x):(n.y-e.y)*(t.x-e.x)>=(t.y-e.y)*(n.x-e.x)},c.intersect=function(e,t,n,r){return c.ccw(e,n,r)!==c.ccw(t,n,r)&&c.ccw(e,t,n)!==c.ccw(e,t,r)},c.degreesToRadians=function(e){return e*Math.PI/180},c.radiansToDegrees=function(e){return 180*e/Math.PI},c.angleRadians=function(e,t){return Math.atan2(t.y-e.y,t.x-e.x)},c.angleDegrees=function(e,t){var n=c.radiansToDegrees(c.angleRadians(e,t));return 0>n?n+360:n},c.angleSector=function(e,t,n){var r=2*Math.PI;return t=t||8,n=n||r/(2*t),0>e&&(e=r+e),e+=n,e>r&&(e-=r),Math.floor(e/(r/t))},c.getRectForPointRing=function(e){var r=e[0],i=r.x,s=r.x,o=r.y,u=r.y;return h.each(e,function(e){i=t(i,e.x),s=n(s,e.x),o=t(o,e.y),u=n(u,e.y)}),new d(i,o,s-i,u-o)},c.hitTestRect=function(e,r){var i=t(r.x,r.x+r.width),s=n(r.x,r.x+r.width),o=t(r.y,r.y+r.height),u=n(r.y,r.y+r.height);return e.x>=i&&e.y>=o&&s>=e.x&&u>=e.y},c.hitTestPointRing=function(e,n){for(var r=new p(0,e.y),i=0,s=0,o=n.length;o>s;s++){var u=n[s],a=n[(s+1)%o];r.x=t(r.x,t(u.x,a.x)-1),i+=this.intersect(r,e,u,a)?1:0}return i%2>0},c.snapPointToLineSegment=function(e,t,n){var r=e.x-t.x,i=e.y-t.y,s=n.x-t.x,o=n.y-t.y,u=s*s+o*o,a=r*s+i*o,f=a/u;return 0>f?new p(t.x,t.y):f>1?new p(n.x,n.y):new p(t.x+s*f,t.y+o*f)},c.getNearestPointToPoint=function(e,t){var n,i,s=null,o=1/0,u=t.length-1;for(t.sort(function(t,n){return t=r(e.x-t.x),n=r(e.x-n.x),n-t});u>=0&&(n=t[u--],o>r(e.x-n.x));)i=c.distance(e,n),o>i&&(s=n,o=i);return s};var v=c.Node=function(e,t,n,r,i){this.id=e,this.x=t||0,this.y=n||0,this.to=i||{},this.data=r||null};v.prototype={toPoint:function(){return{x:this.x,y:this.y,data:this.data||null}}};var m=c.Polygon=function(e,t,n){this.id=e,this.nodes=t.slice(),this.data=n||null},g=c.Path=function(e,t,n){this.nodes=e||[],this.weight=t||0,this.estimate=n||0};g.prototype={copy:function(e,t){return new g(this.nodes.slice(),e||this.weight,t||this.estimate)},last:function(){return this.nodes[this.nodes.length-1]},contains:function(e){return h.contains(e)},prioratize:function(e,t){return t.estimate-e.estimate}};var y=c.Grid=function(e){this.reset(e)};return y.prototype={nodes:{},polys:{},_i:0,toJSON:function(){return{nodes:this.nodes,polys:this.polys,i:this._i}},reset:function(e){this.nodes={},this.polys={},this._i=0,e&&(this._i=e.i||0,h.each(e.nodes||{},function(e){this.nodes[e.id]=e},this),h.each(e.polys||{},function(e){this.polys[e.id]=e},this))},addNode:function(e,t,n){"object"==typeof e&&(n=e,e=0);var r=new v(n&&n.id||"n"+this._i++,e,t,n);return this.nodes[r.id]=r,r},getNodeById:function(e){return this.nodes.hasOwnProperty(e)?this.nodes[e]:null},getNodes:function(e,t){return(!i(e)||t)&&(e=o(arguments)),h.map(e.slice(),function(e){return this.getNodeById(e)},this)},getNumNodes:function(){return h.size(this.nodes)},hasNodes:function(e,t){return(!i(e)||t)&&(e=o(arguments)),h.all(e,function(e){return this.nodes.hasOwnProperty(e)},this)},joinNodes:function(e,t){(!i(e)||t)&&(e=o(arguments));var n=!1;return e.length>1&&this.hasNodes(e)&&h.each(e,function(t){for(var r=this.nodes[t],i=e.length,s=0;i>s;)t=e[s++],t!==r.id&&(r.to[t]=1,n=!0)},this),n},splitNodes:function(e,t){if((!i(e)||t)&&(e=o(arguments)),2>e.length)return this.detachNodes(e);var n=!1;return h.each(e,function(t){var r=this.nodes[t];if(r&&r.to)for(t in r.to)h.contains(e,t)&&(delete r.to[t],n=!0)},this),n},detachNodes:function(e,t){(!i(e)||t)&&(e=o(arguments));var n=!1;return h.each(e,function(e){var t,r,i=this.nodes[e];if(i&&i.to){for(r in i.to)delete i.to[r],t=this.nodes[r],t&&t.to&&delete t.to[e];n=!0}},this),n},removeNodes:function(e,t){(!i(e)||t)&&(e=o(arguments));var n=this.detachNodes(e);return h.each(e,function(e){var t,r;if(this.nodes.hasOwnProperty(e)){delete this.nodes[e];for(r in this.polys)t=this.polys[r],t&&h.contains(t.nodes,e)&&delete this.polys[r];n=!0}},this),n},addPolygon:function(e,t){if(e.length>=3&&this.hasNodes(e)){var n=new m("p"+this._i++,e,t);return this.polys[n.id]=n,n}return null},getPolygonById:function(e){return this.polys.hasOwnProperty(e)?this.polys[e]:null},getPolygons:function(e,t){return(!i(e)||t)&&(e=o(arguments)),h.map(e.slice(),this.getPolygonById,this)},getNodesForPolygon:function(e){return this.polys.hasOwnProperty(e)?h.map(this.polys[e].nodes.slice(),this.getNodeById,this):null},getNumPolygons:function(){return h.size(this.polys)},removePolygons:function(e,t){(!i(e)||t)&&(e=o(arguments));var n=!1;return h.each(e,function(e){this.polys.hasOwnProperty(e)&&(delete this.polys[e],n=!0)},this),n},findPath:function(e,t,n,r){var i,o,u,a,f,l,h,p=[],d={},v=this.getNodeById(e),m=this.getNodeById(t),y=0;for(s(n)||(n=c.distance),s(r)||(r=c.distance),p.push(new g([v],n(v,v)));p.length>0;){o=p.pop(),v=o.last();for(h in v.to)v.to.hasOwnProperty(h)&&(u=this.nodes[h],u&&!o.contains(u)&&(f=o.weight+n(v,u),(d[u.id]||f)>=f&&(d[u.id]=f,l=f+r(u,m),(!i||i.weight>l)&&(a=o.copy(f,l),a.nodes.push(u),u.id===m.id?i=a:p.push(a)))));p.sort(g.prototype.prioratize),y++}return{cycles:y,valid:!!i,nodes:i?i.nodes:[],weight:i?i.weight:0}},findPathWithFewestNodes:function(e,t){var n=function(){return 1};return this.findPath(e,t,n,n)},snapPointToGrid:function(e){var t=null,n=1/0,r=[],i={};return h.each(this.nodes,function(s,o){if(e.id!==o)for(var u in s.to)if(s.to.hasOwnProperty(u)&&!i.hasOwnProperty(u+" "+s.id)){var a=this.nodes[u],f=c.snapPointToLineSegment(e,s,a),l=c.distance(e,f);i[s.id+" "+a.id]=!0,(!t||n>l)&&(t=f,n=l,r[0]=s.id,r[1]=a.id)}},this),{offset:isFinite(n)?n:0,point:t||e,segment:r}},snapPoint:function(e){var t=this.snapPointToGrid(e);return t.point||e},getNearestNodeToNode:function(e){var t=[],n=this.getNodeById(e);return n?(h.each(this.nodes,function(e){e.id!==n.id&&t.push(e)},this),c.getNearestPointToPoint(n,t)):null},getNearestNodeToPoint:function(e){return c.getNearestPointToPoint(e,h.toArray(this.nodes))},hitTestPointInPolygons:function(e){return!!this.getPolygonsOverPoint(e).length},getPolygonsOverPoint:function(e){var t=[];for(var n in this.polys)this.polys.hasOwnProperty(n)&&c.hitTestPointRing(e,this.getNodesForPolygon(n))&&t.push(n);return t},getNodesInPolygon:function(e){var t=[],n=this.getPolygonById(e),r=this.getNodesForPolygon(e),i=c.getRectForPointRing(r);return n&&h.each(this.nodes,function(e){(h.contains(n.nodes,e.id)||c.hitTestRect(e,i)&&c.hitTestPointRing(e,r))&&t.push(e.id)},this),t},getNodesInRect:function(e){var t=[];return h.each(this.nodes,function(n){c.hitTestRect(n,e)&&t.push(n.id)},this),t},getAdjacentPolygonSegments:function(e,t){for(var n=[],r=this.getNodesForPolygon(e),i=this.getNodesForPolygon(t),s=r.length,o=i.length,a=0;s>a;a++)for(var f=r[a].id,l=r[(a+1)%s].id,c=0;o>c;c++){var h=i[c].id,p=i[(c+1)%o].id;u(f,l,h,p)&&n.push([f,l])}return n},getPolygonsWithLineSegment:function(e,t){var n=[];return h.each(this.polys,function(r,i){for(var s=0,o=r.nodes.length;o>s;s++){var a=r.nodes[s],f=r.nodes[(s+1)%o];u(a,f,e,t)&&n.push(i)}}),n},getContiguousNodesMap:function(){function e(t,i){n[t.id]=i[t.id]=1;for(var s in t.to)t.to.hasOwnProperty(s)&&!i.hasOwnProperty(s)&&(i=e(r.getNodeById(s),i));return i}var t=[],n={},r=this;return h.each(this.nodes,function(r){n.hasOwnProperty(r.id)||t.push(e(r,{}))}),t},bridgePoints:function(e,t,n){var r=this.getPolygonsOverPoint(e),i=this.getPolygonsOverPoint(t);if(a(this,e,t,r,i))return[e,t];var s=f(this,e,r),o=f(this,t,i);l(s,o)&&this.joinNodes(s.id,o.id);var u=this.findPath(s.id,o.id);return this.removeNodes(s.id,o.id),u.valid?(u=h.map(u.nodes,function(e){return e.toPoint()}),c.distance(e,s)>1&&u.unshift(e),!n&&c.distance(t,o)>1&&u.push(t),u):[]}},c}),function(){function e(){try{return i in n&&n[i]}catch(e){return!1}}var t={},n=window,r=n.document,i="localStorage",s="__storejs__",o;t.disabled=!1,t.set=function(e,t){},t.get=function(e){},t.remove=function(e){},t.clear=function(){},t.transact=function(e,n,r){var i=t.get(e);r==null&&(r=n,n=null),typeof i=="undefined"&&(i=n||{}),r(i),t.set(e,i)},t.getAll=function(){},t.serialize=function(e){return JSON.stringify(e)},t.deserialize=function(e){if(typeof e!="string")return undefined;try{return JSON.parse(e)}catch(t){return e||undefined}};if(e())o=n[i],t.set=function(e,n){return n===undefined?t.remove(e):(o.setItem(e,t.serialize(n)),n)},t.get=function(e){return t.deserialize(o.getItem(e))},t.remove=function(e){o.removeItem(e)},t.clear=function(){o.clear()},t.getAll=function(){var e={};for(var n=0;n<o.length;++n){var r=o.key(n);e[r]=t.get(r)}return e};else if(r.documentElement.addBehavior){var u,a;try{a=new ActiveXObject("htmlfile"),a.open(),a.write('<script>document.w=window</script><iframe src="/favicon.ico"></frame>'),a.close(),u=a.w.frames[0].document,o=u.createElement("div")}catch(f){o=r.createElement("div"),u=r.body}function l(e){return function(){var n=Array.prototype.slice.call(arguments,0);n.unshift(o),u.appendChild(o),o.addBehavior("#default#userData"),o.load(i);var r=e.apply(t,n);return u.removeChild(o),r}}var c=new RegExp("[!\"#$%&'()*+,/\\\\:;<=>?@[\\]^`{|}~]","g");function h(e){return e.replace(c,"___")}t.set=l(function(e,n,r){return n=h(n),r===undefined?t.remove(n):(e.setAttribute(n,t.serialize(r)),e.save(i),r)}),t.get=l(function(e,n){return n=h(n),t.deserialize(e.getAttribute(n))}),t.remove=l(function(e,t){t=h(t),e.removeAttribute(t),e.save(i)}),t.clear=l(function(e){var t=e.XMLDocument.documentElement.attributes;e.load(i);for(var n=0,r;r=t[n];n++)e.removeAttribute(r.name);e.save(i)}),t.getAll=l(function(e){var n=e.XMLDocument.documentElement.attributes,r={};for(var i=0,s;s=n[i];++i){var o=h(s.name);r[s.name]=t.deserialize(e.getAttribute(o))}return r})}try{t.set(s,s),t.get(s)!=s&&(t.disabled=!0),t.remove(s)}catch(f){t.disabled=!0}t.enabled=!t.disabled,typeof module!="undefined"&&typeof module!="function"?module.exports=t:typeof define=="function"&&define.amd?define("lib/store",t):this.store=t}(),define("mod/grid-m",["lib/backbone","lib/underscore","lib/constellation","lib/store"],function(e,t,n,r,i){var s=["addNode","joinNodes","splitNodes","removeNodes","addPolygon","removePolygons","reset"],o=t.extend(new n.Grid,e.Events,{bg:"",init:function(){this.listenTo(this,"change",this.save);var e=this;return t.each(s,function(t){e[t]=function(){n.Grid.prototype[t].apply(e,arguments),e.update()}}),this},setBackground:function(e){this.bg=e,this.save(),this.update()},load:function(){var e=r.get("constellation");this.bg=e&&e.bg||"",this.reset(e)},save:function(e){var t=this.toJSON();t.bg=this.bg,r.set("constellation",t)},update:function(){this.trigger("change")}});return o.init()}),define("mod/selection-m",["lib/underscore","lib/backbone"],function(e,t){var n=t.Model.extend({items:[],path:[],type:"",selectionSize:function(){return this.items.length},setSelection:function(e){this.setType(e[0]),this.items=e.slice(),this.update()},setType:function(e){e=e||"",e.length&&(e=e.substr(0,1).toLowerCase()),this.type.length&&this.type!==e&&this.deselectAll(),this.type=e},toggle:function(e){return this.setType(e),this.select(e)?!0:(this.deselect(e),!1)},contains:function(t){return e.contains(this.items,t)},select:function(e){return this.setType(e),this.contains(e)?!1:(this.items.push(e),this.path.length=0,this.update(),!0)},deselect:function(t){return this.contains(t)?(this.items.splice(e.indexOf(this.items,t),1),this.path.length=0,this.update(),!0):!1},deselectAll:function(e){this.items.length=0,this.path.length=0,this.type="",e||this.update()},selectPath:function(e,t){this.path=e.slice(),t||this.update()},update:function(){this.trigger("update")}});return new n}),define("mod/window-v",["lib/jquery","lib/underscore","lib/backbone"],function(e,t,n){function r(){function s(){r.width=i.width(),r.height=i.height()}var r=this,i=e(window);t.extend(r,n.Events),r.RESIZE="resize",i.on("resize",function(){s(),r.trigger(r.RESIZE)}),s()}return new r}),define("mod/grid-v",["lib/jquery","lib/underscore","lib/backbone","./grid-m","./selection-m","./window-v"],function(e,t,n,r,i,s){var o=n.View.extend({el:"#grid",model:r,selectedViews:[],lastTouch:0,lastBg:"",events:{mousedown:"onTouch"},initialize:function(){this.listenTo(r,"change",this.render),this.listenTo(s,"resize",this.setFrame),this.listenTo(i,"update",this.setSelection),this.setFrame()},getPathForNodes:function(e){var n="";return t.each(e,function(e,t){n+=(t<=0?"M":"L")+e.x+" "+e.y+" "}),n+"Z"},render:function(){var n=this,i={},s={},o=r.nodes,u,a;t.each(r.polys,function(e,t){s[e.id]={id:e.id,nodes:e.nodes.join(" "),d:n.getPathForNodes(r.getNodesForPolygon(e.id))}}),t.each(o,function(e,t){for(a in e.to)e.to.hasOwnProperty(a)&&o.hasOwnProperty(a)&&(u=o[a],i.hasOwnProperty(u.id+" "+e.id)||(i[e.id+" "+u.id]={id:e.id+" "+u.id,x1:e.x,y1:e.y,x2:u.x,y2:u.y}))}),this.tmpl=this.tmpl||t.template(e("#grid-view").html()),this.$el.html(this.tmpl({nodes:o,lines:i,polys:s})),this.selectedViews.length=0,this.setSelection(),this.lastBg!==r.bg&&(this.$el.css("background",r.bg?"url("+r.bg+") no-repeat":""),this.lastBg=r.bg)},setFrame:function(){this.x=this.x||parseInt(this.$el.css("margin-left").slice(0,-2),10),this.y=this.y||e(".header").outerHeight(),this.$el.width(s.width-this.x).height(s.height-this.y)},clearSelection:function(){t.each(this.selectedViews,function(t){t=e(t),t.is("li")?t.removeClass("select").children(":first-child").text(""):t[0].setAttribute("class",t[0].getAttribute("class").replace(/[\s]?select[\s]?/g,""))}),this.selectedViews.length=0},setSelection:function(){var n=this;this.clearSelection(),t.each(i.items,function(t,r){t=document.getElementById(t);if(!t)return;t.tagName.toLowerCase()==="li"?e(t).addClass("select").children(":first").text(r+1):t.setAttribute("class",t.getAttribute("class")+" select"),n.selectedViews.push(t)});if(i.path.length){var r=[];for(var s=0,o=i.path.length-1;s<o;s++)r.push("line."+i.path[s]+"."+i.path[s+1]);e(r.join(",")).each(function(){this.setAttribute("class",this.getAttribute("class")+" select"),n.selectedViews.push(this)})}},localizeEventOffset:function(e){var t=this.$el.offset();return t.left=e.pageX-t.left,t.top=e.pageY-t.top,t},drag:function(t,n,r){var i=this,s=!1;e(document).on("mouseup",function(t){return e(document).off("mouseup mousemove"),typeof n=="function"&&n(i.localizeEventOffset(t)),typeof r=="function"&&r(s),!1}).on("mousemove",function(e){return s=!0,t(i.localizeEventOffset(e)),!1})},dragGeom:function(t,n,i){var s=this,o=this.$el.find("#"+t.join(",#")),u=this.$el.find("line."+t.join(",line.")),a=this.$el.find("path."+t.join(",path."));this.drag(function(t){n.left-=t.left,n.top-=t.top,o.each(function(){var t=e(this),i=r.getNodeById(t.attr("id"));t.css({left:i.x-=n.left,top:i.y-=n.top})}),u.each(function(){var e=this.getAttribute("class").split(" "),t=r.getNodeById(e[0]),n=r.getNodeById(e[1]);this.setAttribute("x1",t.x),this.setAttribute("y1",t.y),this.setAttribute("x2",n.x),this.setAttribute("y2",n.y)}),a.each(function(){var e=this.getAttribute("id"),t=r.getNodesForPolygon(e);this.setAttribute("d",s.getPathForNodes(t))}),n=t},function(){r.save()},i)},dragMarquee:function(n){function o(e,t){var n=Math.min(e.left,t.left),r=Math.max(e.left,t.left),i=Math.min(e.top,t.top),o=Math.max(e.top,t.top),u={x:n,y:i,left:n,top:i,width:r-n,height:o-i};return s.css(u),u}var s=e("#marquee").show();o(n,n),this.drag(function(e){o(n,e)},function(e){t.each(r.getNodesInRect(o(n,e)),function(e){i.select(e)}),s.hide()})},touchNode:function(e,t,n,r){var s=i.contains(e),o=!1;n?(s=i.toggle(e),o=!0):s||(i.deselectAll(),i.select(e),s=!0),s&&this.dragGeom(i.items,t,function(t){!t&&!o&&(i.deselectAll(),i.select(e))})},touchPoly:function(e,t,n,s){if(s){var o=r.getPolygonById(e).nodes;i.setSelection(o)}else n||i.deselectAll(),i.toggle(e)&&this.dragGeom(r.getPolygonById(e).nodes,t)},touchCanvas:function(e,t,n){n?r.addNode(e.left,e.top):(t||i.deselectAll(),this.dragMarquee(e))},onTouch:function(t){var n=e(t.target),r=t.timeStamp-this.lastTouch<250,i=this.localizeEventOffset(t),s;return n=n.is("li > span")?n.parent():n,s=n.attr("id"),this.lastTouch=t.timeStamp,n.is("li")?this.touchNode(s,i,t.shiftKey,r):n.is("path")?this.touchPoly(s,i,t.shiftKey,r):this.touchCanvas(i,t.shiftKey,r),!1}});return new o}),define("mod/grid-c",["lib/underscore","lib/backbone","lib/constellation","./grid-m","./selection-m"],function(e,t,n,r,i){var s=t.Model.extend({nodeOpsEnabled:function(){return i.type==="n"},newGrid:function(){i.deselectAll(!0),r.reset()},saveGrid:function(){r.save()},print:function(){typeof console!="undefined"&&console.log?(console.log(JSON.stringify(r.toJSON())),this.alert("Grid data printed to your console")):this.alert("No console available")},joinNodes:function(){this.nodeOpsEnabled()&&i.selectionSize()>1?r.joinNodes(i.items):this.alert("Select two or more nodes",i.selectionSize())},splitNodes:function(){this.nodeOpsEnabled()&&i.selectionSize()>1?r.splitNodes(i.items):this.alert("Select two or more joined nodes",i.selectionSize())},makePolygon:function(){this.nodeOpsEnabled()&&i.selectionSize()>=3?r.addPolygon(i.items):this.alert("Select three or more nodes",i.selectionSize())},deleteGeometry:function(){if(!i.selectionSize()){this.alert("No selected geometry");return}this.nodeOpsEnabled()?r.removeNodes(i.items):r.removePolygons(i.items),i.deselectAll()},findPath:function(){if(this.nodeOpsEnabled()&&i.selectionSize()===2){var t=r.findPath(i.items[0],i.items[1]);t.valid?(i.selectPath(e.pluck(t.nodes,"id")),this.alert("Shortest route of "+Math.round(t.weight)+"px")):this.alert("No valid routes")}else this.alert("Select two nodes",i.selectionSize())},snapNodeToGrid:function(){if(this.nodeOpsEnabled()&&i.selectionSize()===1){var t=r.getNodeById(i.items[0]),n=r.snapPoint(t);e.size(t.to)?this.alert("Node must be unconnected"):(t.x=n.x,t.y=n.y,r.update())}else this.alert("Select a single node")},selectNearestGridNode:function(){if(this.nodeOpsEnabled()&&i.selectionSize()===1){var e=r.getNearestNodeToNode(i.items[0]);i.select(e.id)}else this.alert("Select a single node")},hitTestGeometry:function(){if(i.selectionSize()===1){var e;if(this.nodeOpsEnabled()){var t=r.getNodeById(i.items[0]);e=r.getPolygonHitsForPoint(t)}else e=r.getNodesInPolygon(i.items[0]);e&&e.length?i.setSelection(e):this.alert("No intersections")}else this.alert("Select a single node or polygon")},alert:function(e,t){this.trigger("alert",e,t)}});return new s}),define("mod/toolbar-v",["lib/jquery","lib/underscore","lib/backbone","./grid-m","./grid-c","./window-v"],function(e,t,n,r,i,s){var o=n.View.extend({el:"#toolbar",initialize:function(){this.listenTo(r,"change",this.render),this.render()},render:function(){this.$(".bg-url").val(r.bg)},events:{"click .action":"onAction","click .bg-load":"onBgLoad","click .bg-clear":"onBgClear","click .bg-demo":"onBgDemo","change select":"onSelectGrid"},onAction:function(t){switch(e(t.currentTarget).attr("data-action")){case"join":i.joinNodes();return;case"split":i.splitNodes();return;case"polygon":i.makePolygon();return;case"remove":i.deleteGeometry();return;case"path":i.findPath();return;case"snap":i.snapNodeToGrid();return;case"nearest":i.selectNearestGridNode();return;case"hittest":i.hitTestGeometry();return;case"print":i.print();return}},onSelectGrid:function(){},onBgLoad:function(e){r.setBackground(this.$(".bg-url").val()),e.preventDefault()},onBgClear:function(e){r.setBackground(""),e.preventDefault()},onBgDemo:function(t){var n=e(t.currentTarget).attr("href");r.setBackground(n),t.preventDefault()}});return new o}),define("mod/message-v",["lib/jquery","lib/backbone","./grid-c","./grid-m"],function(e,t,n,r){var i=t.View.extend({el:"#message",empty:!1,initialize:function(){this.listenTo(n,"alert",this.onAlert),this.listenTo(r,"change",this.onTestEmpty),this.$el.hide()},onTestEmpty:function(){r.getNumNodes()?this.empty&&(this.$el.clearQueue().fadeOut(500),this.empty=!1):(this.$el.clearQueue().html("Double-click to add nodes...<span>Click and drag for selection marquee</span>").fadeIn(),this.empty=!0)},onAlert:function(e,t){r.getNumNodes()>0?this.$el.clearQueue().html(e+(t?"<span>SHIFT+click adds to selection</span>":"")).show().delay(2500).fadeOut(500):this.$el.clearQueue().animate({marginLeft:"-=5px"},50).animate({marginLeft:"+=10px"},100).animate({marginLeft:"-=10px"},100).animate({marginLeft:"+=10px"},100).animate({marginLeft:"-=5px"},50)}});return new i}),define("mod/info-v",["lib/jquery","lib/backbone","./window-v"],function(e,t,n){var r=t.View.extend({el:"#info",events:{"click button":"onToggle"},onToggle:function(){this.$el.toggleClass("closed");var t=!this.$el.hasClass("closed"),n=this;this.$win=this.$win||e(window),this.$win.off("click.info"),t&&this.$win.on("click.info",function(t){e(t.target).closest(n.$el).length||n.onToggle()}),this.$(".toggle").text(t?"x":"?")}});return new r}),define("mod/keyboard-c",["lib/jquery","./grid-c"],function(e,t){function r(e){e.preventDefault()}var n=!0;e(window).on("keydown",function(e){if(n)switch(e.which){case 8:return r(e),t.deleteGeometry(),!1;case 66:return r(e),t.splitNodes(),!1;case 67:return r(e),t.print(),!1;case 74:return r(e),t.joinNodes(),!1;case 80:return r(e),t.makePolygon(),!1;case 70:return r(e),t.findPath(),!1;case 83:return r(e),t.snapNodeToGrid(),!1;case 78:return r(e),e.ctrlKey?t.newGrid():t.selectNearestGridNode(),!1;case 72:return r(e),t.hitTestGeometry(),!1}}),e("input").on("focus",function(e){n=!1}).on("blur",function(e){n=!0})}),requirejs.config({paths:{}}),define("main",["mod/grid-v","mod/toolbar-v","mod/message-v","mod/info-v","mod/grid-m","mod/keyboard-c"],function(e,t,n,r,i,s){i.load()});